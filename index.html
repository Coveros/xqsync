<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!--
/*
 * Copyright (c)2005-2012 Mark Logic Corporation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * The use of the Apache License does not indicate that this project is
 * affiliated with the Apache Software Foundation.
 */
-->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>XQSync README</title>
<style type="text/css">
tr {
  vertical-align: top;
}
</style>
</head>
<body>
<h1>XQSync</h1>

<p>
To get started using XQSync, try the <a href="tutorial.html">tutorial</a>.
For the source code, see the
<a href="http://github.com/marklogic/xqsync">project page on github</a>.
</p>

<h2>Running XQSync</h2>
<p>XQSync is a Java command-line tool.
The entry point is the main method in the
<code>com.marklogic.ps.xqsync.XQSync</code> class.
This class takes zero or more property files as its arguments.
Any specified system properties will override file-based properties,
and properties found in later files may override properties
specified in earlier files on the command line.
See
<code><a href="http://github.com/marklogic/xqsync/raw/master/src/xqsync.sh">src/xqsync.sh</a></code>
for a sample shell script.
</p>

<p>
<b>Note:</b>
XQSync needs a lot of heap space for large synchronization tasks.
Be prepared to increase the Java VM heap space limit,
using <code>-Xmx</code>. Depending on the version of Java used,
<code>-Xincgc</code> may also help.
</p>

<h2>Required libraries:</h2>
<ul>
  <li>MarkLogic <a href="http://developer.marklogic.com/">XCC</a></li>
  <li><a href="xqsync.jar">xqsync.jar</a></li>
  <li>Codehaus <a href="http://xstream.codehaus.org/">XStream</a></li>
  <li><a href="http://www.extreme.indiana.edu/xgws/xsoap/xpp/">XPP3</a>
  XML Pull-Parser
  (links to the jar files seem to be broken, so here is
    <a href="xpp3-1.1.4c.jar">xpp3.jar</a>).
  </li>
</ul>

<p>
You can also download
<a href="https://github.com/marklogic/xqsync/commits/gh-pages/xqsync.jar">
older versions of xqsync.jar</a>.
</p>

<h2>Required properties:</h2>
<ul>
<li>
  one of:
  <code>INPUT_PACKAGE</code>,
  <code>INPUT_CONNECTION_STRING</code>
  </li>
<li>
  one of:
  <code>OUTPUT_PACKAGE</code>,
  <code>OUTPUT_CONNECTION_STRING</code>
  </li>
</ul>

<p>
  Note that this requirements can be overriden by a subclass
  of <code>com.marklogic.ps.xqsync.Configuration</code>.
  See <a href="#Customization">Customization</a> for details.
</p>

<h2>Available properties:</h2>
<table border="1" summary="properties">
<tr><th>Property</th><th>default value</th><th>notes</th></tr>
<tr>
  <td>ALLOW_EMPTY_METADATA</td>
  <td>false</td>
  <td>
    If true, missing metadata files
    in <code>INPUT_PACKAGE</code> will be ignored.
  </td>
</tr>

<tr>
  <td>CONFIGURATION_CLASSNAME</td><td>null</td>
  <td>
    If non-null, this class will be used instead of
    <code>com.marklogic.ps.xqsync.Configuration</code>.
    For details, see <a href="#Customization">Customization</a>.
  </td>
</tr>

<tr>
  <td>COPY_COLLECTIONS</td><td>true</td>
  <td>If true, all document collections are copied.</td>
</tr>
<tr>
  <td>COPY_PERMISSIONS</td><td>true</td>
  <td>If true, all document permissions are copied.</td>
</tr>
<tr>
  <td>COPY_PROPERTIES</td><td>true</td>
  <td>If true, document properties are copied.
    When targeting an output connection that has CPF enabled,
    it is a good idea to disable this setting.
  </td>
</tr>
<tr>
  <td>COPY_QUALITY</td><td>true</td>
  <td>If true, document quality is copied.</td>
</tr>

<tr>
  <td>DELETE_COLLECTION</td>
  <td>false</td>
  <td>In combination with INPUT_COLLECTION_URI and OUTPUT_CONNECTION_STRING,
  delete the INPUT_COLLECTION_URI on the OUTPUT_CONNECTION_STRING,
  before beginning synchronization.</td>
</tr>

<tr>
  <td>FATAL_ERRORS</td><td>true</td>
  <td>
    If true, all exceptions are fatal.
    If false, exceptions will still be logged,
    but in most cases XQSync will proceed.
  </td>
</tr>

<tr>
  <td>INPUT_BATCH_SIZE</td>
  <td>1</td>
  <td>
    Process documents in batches of N documents.  When exporting many
    small documents from an input database, increasing this setting
    can improve performance.  Note that the right setting will vary
    according to document size: if the batch size is too large, poor
    performance or errors may result.  Imports are also done in
    batches of N documents.
  </td>
</tr>
<tr>
  <td>INPUT_CONNECTION_STRING</td>
  <td>null</td>
  <td>
    Input documents will come from this XCC connection.
    By default, every document in the input database will be transferred.
    To change this behavior, use exactly one of the related properties:
    <ul>
      <li><code>INPUT_DOCUMENT_URIS</code></li>
      <li><code>INPUT_COLLECTION_URI</code></li>
      <li><code>INPUT_DIRECTORY_URI</code></li>
      <li><code>INPUT_QUERY</code></li>
    </ul>
    NB - if more than one key is specified, XQSync will use the first one
    it finds, using the order above.
    <br/>
    NB - to list all input documents, or to list a collection or a directory,
    XQSync uses <code>cts:uris()</code>.
    If the document URI lexicon is not available,
    it will fall back to a slower technique.
    <br/>
    If the connection string uses the <code>xccs://</code> scheme,
    XQSync will attempt to use SSL for server communications.
    This requires MarkLogic Server 4.1 or later.
    <br/>
    The list of URIs are stored in a temporary file by default.  The
    location of the file can be specified directly (see the
    URI_QUEUE_FILE property).  Another way to specify this location is
    provide a temporary directory (see the TMP_DIR property).  If none
    of these properties are specified, xqsync would use the OS
    platform's default temporary directory.
  </td>
</tr>
<tr>
  <td>INPUT_COLLECTION_URI</td>
  <td>null</td>
  <td>In combination with <code>INPUT_CONNECTION_STRING</code>,
  all documents in the named collection(s) will be transferred.
  If whitespace is present, <code>INPUT_COLLECTION_URI</code>
  will be treated as a whitespace-delimited sequence;
  e.g., <code>INPUT_COLLECTION_URI=a b</code> would transfer all documents
  in either collection <code>a</code> or collection <code>b</code>.
  </td>
</tr>
<tr>
  <td>INPUT_DIRECTORY_URI</td>
  <td>null</td>
  <td>In combination with <code>INPUT_CONNECTION_STRING</code>,
  all documents in the named directory will be transferred.
  If whitespace is present, <code>INPUT_DIRECTORY_URI</code>
  will be treated as a whitespace-delimited sequence;
  e.g., <code>INPUT_DIRECTORY_URI=a/ b/</code> would transfer all documents
  whose URIs begin with <code>a/</code> or <code>b/</code>.
  </td>
</tr>
<tr>
  <td>INPUT_DOCUMENT_URIS</td>
  <td>null</td>
  <td>In combination with <code>INPUT_CONNECTION_STRING</code>,
  all documents named by the (whitespace-delimited) uris will be transferred.
  </td>
</tr>
<tr>
  <td>INPUT_MODULE_URI</td>
  <td>null</td>
  <td>
    <p>If this property and <code>INPUT_CONNECTION_STRING</code> are both set,
    the named module will be used to process each document
    as it is read from the input database.
    The module must define a module variable
    <code>$URI as xs:string external</code>.
    The module must return a document-node.
    </p>
    <p>Here is a simple example module, which recursively transforms
      the input document to lower-case all element names.
      Note that the first call to <code>local:lc()</code>
      will always receive a document-node
      (unless the document <code>$URI</code> does not exist),
      and so the entire module will always return a document-node.
    </p>
    <pre>
xquery version "1.0-ml" ;

declare variable $URI as xs:string external ;

declare function local:lc($list as node()*)
 as node()*
{
  for $n in $list
  return typeswitch($n)
  case document-node() return document {
    local:lc($n/node()) }
  case element() return element { node-name($n) } {
    $n/@*,
    local:lc($n/node())
  }
  default return $n
} ;

local:lc(doc($URI))
      </pre>
  </td>
</tr>
<tr>
  <td>INPUT_PACKAGE</td>
  <td>null</td>
  <td>Input documents will come from this zip file path.
    If the path is a directory, any "*.zip" children will be used.
  </td>
</tr>
<!--
<tr>
  <td>INPUT_PATH</td>
  <td>null</td>
  <td>Input documents will come from this filesystem path.</td>
</tr>
-->
<tr>
  <td>INPUT_QUERY</td>
  <td>null</td>
  <td>
    <p>In combination with <code>INPUT_CONNECTION_STRING</code>,
    all uris returned by the query will be transferred.
    This sample query would transfer the first 100 documents,
    in document order:
    <br/>
    <code>for $i in doc()[1 to 100] return xdmp:node-uri($i)</code>
    <br/>
    If the document URI lexicon is enabled, this could be written as:
    <br/>
    <code>cts:uris('', 'document')[1 to 100]</code>
    <br/>
    to transfer the first 100 documents, sorted by document URI.
    </p>
    <p>If the query contains any repeated semicolons (";;"),
      it will be split into multiple queries and run separately.
      This permits faster start-up with complex queries.
    </p>
  </td>
</tr>
<tr>
  <td>INPUT_QUERY_CACHABLE</td>
  <td>false</td>
  <td>
    In combination with <code>INPUT_CONNECTION_STRING</code>,
    the query which fetches the input document URIs
    will instruct XCC to cache or to stream the URIs.
    If set to <code>true</code>,
    no documents will sync until all URIs have been fetched.
    This is usually undesirable, so <code>false</code> is the default.
  </td>
</tr>
<tr>
  <td>INPUT_QUERY_BUFFER_BYTES</td>
  <td>0</td>
  <td>
    In combination with <code>INPUT_CONNECTION_STRING</code>,
    the query which fetches the input document URIs
    will use this buffer size.
    The value 0 will cause XCC to use its default size.
  </td>
</tr>
<tr>
  <td>INPUT_START_POSITION</td>
  <td>null</td>
  <td>Use the numeric value of this property as the starting position
  for the sequence of input documents.</td>
</tr>
<tr>
  <td>INPUT_TIMESTAMP</td>
  <td>null</td>
  <td>
    If not null, and <code>INPUT_CONNECTION_STRING</code> is set,
    then all input queries will use this timestamp.
    The special value <code>#AUTO</code>
    will cause the first request timestamp
    to be used for the entire synchronization.
  </td>
</tr>

<tr>
  <td>INPUT_RESULT_BUFFER_SIZE</td>
  <td>0</td>
  <td>
    In combination with <code>INPUT_CONNECTION_STRING</code>,
    the query which fetches each input document and its metadata
    will use this buffer size.
    The value 0 will cause XCC to use its default size.
  </td>
</tr>

<tr>
  <td>INPUT_INDENTED</td>
  <td>true</td>
  <td>
    By default, when retrieving documents from MarkLogic, the
    MarkLogic server would pretty-indent XML elements.  You can turn
    off this behavior by setting INPUT_INDENTED to false.  This is
    equivalent to setting "declare boundary-space preserve; declare
    option xdmp:output \"indent=no\";" in the prolog section of an
    XQuery module.
  </td>
</tr>

<tr>
  <td>LOG_FORMATTER</td><td>null</td>
  <td>Xqsync logs everything on a single line by default.  You can
  specify this property to SimpleFormatter to restore xqsync's
  original 2-line logging format.</td>
</tr>
<tr>
  <td>LOG_LEVEL</td><td>INFO</td>
  <td>java.util.logger.Level at which to log.</td>
</tr>
<tr>
  <td>LOG_HANDLER</td><td>CONSOLE,FILE</td>
  <td>java.util.logger log handlers with which to log.</td>
</tr>
<tr>
  <td>USE_MULTI_STMT_TXN</td>
  <td>false</td>
  <td>
    If true, batch inserts will use MarkLogic 5.0's multi-statement
    transaction feature.  If false, batch inserts will use XCC's
    insertContent([]) API.
  </td>
</tr>
<tr>
  <td>OUTPUT_CONNECTION_STRING</td>
  <td>null</td>
  <td>
    Documents will be written to this XCC connection.
    <br/>
    If the connection string uses the <code>xccs://</code> scheme,
    XQSync will attempt to use SSL for server communications.
    This requires MarkLogic Server 4.1 or later.
    If the property includes multiple, whitespace-delimited connection strings,
    XQSync will round-robin documents across the available connections.
  </td>
</tr>
<tr>
  <td>OUTPUT_COLLECTIONS</td>
  <td>null</td>
  <td>Output documents will be added to one or more collection URIs.
    Collection URIs may be delimited by whitespace, commas, or colons.
  </td>
</tr>
<tr>
  <td>OUTPUT_CONNECTION_STRING</td>
  <td>null</td>
  <td>
    Documents will be written to this XCC connection.
    <br/>
    If the connection string uses the <code>xccs://</code> scheme,
    XQSync will attempt to use SSL for server communications.
    This requires MarkLogic Server 4.1 or later.
    If the property includes multiple, whitespace-delimited connection strings,
    XQSync will round-robin documents across the available connections.
  </td>
</tr>

<tr>
  <td>OUTPUT_FILTER_FORMATS</td><td>null</td>
  <td>The specified list of document types will not be copied to output.
    <br/>Example: <code>OUTPUT_FILTER_FORMATS=binary()</code>
    <br/>Example: <code>OUTPUT_FILTER_FORMATS=text(),xml</code>
  </td>
</tr>
<tr>
  <td>OUTPUT_FORESTS</td><td>null</td><td>Permitted output forest names.</td>
</tr>
<!--
<tr>
  <td>OUTPUT_PATH</td>
  <td>null</td>
  <td>Output documents will be written to this filesystem path.</td>
</tr>
-->
<tr>
  <td>OUTPUT_PACKAGE</td>
  <td>null</td>
  <td>Output documents will be written to this zip file path.</td>
</tr>

<tr>
  <td>PRINT_CURRENT_RATE</td>
  <td>false</td>
  <td>By default, xqsync would print out the overall rate of document
  transfers every minute.  By specifying this property to true, xqsync
  would also print out the current (last 1-minute) running rate.</td>
</tr>

<tr>
  <td>QUEUE_SIZE</td>
  <td>100,000</td>
  <td>
    Maximum size of the synchronization queue,
    to limit memory consumption by XQSync.
    You may wish to use a smaller value,
    if you encounter OutOfMemoryError.
    You may wish to use a larger value,
    if using many threads and loading very small documents.
    If you use a large value,
    you may also need something like <code>-Xmx4096m</code>
    to increase the Java heap size.
    Plan for roughly 1-GB per 1-M queue entries (ie, 1-kB per entry).
  </td>
</tr>

<tr>
  <td>REPAIR_MULTIPLE_DOCUMENTS_PER_URI</td><td>false</td>
  <td>Normally not necessary, this property will cause XQSync
    to generate XQuery that prevents <code>doc()</code>
    from returning multiple documents per URI.</td>
</tr>
<tr>
  <td>REPAIR_INPUT_XML</td><td>false</td>
  <td>Should MarkLogic Server try to repair malformed input XML?</td>
</tr>

<tr>
  <td>ROLES_EXECUTE</td><td>null</td>
  <td>Names of any roles to attach to output documents
    as execute permissions.</td>
</tr>
<tr>
  <td>ROLES_INSERT</td><td>null</td>
  <td>Names of any roles to attach to output documents
    as insert permissions.</td>
</tr>
<tr>
  <td>ROLES_READ</td><td>null</td>
  <td>Names of any roles to attach to output documents
    as read permissions.</td>
</tr>
<tr>
  <td>ROLES_UPDATE</td><td>null</td>
  <td>Names of any roles to attach to output documents
    as update permissions.</td>
</tr>

<tr>
  <td>SKIP_EXISTING</td><td>false</td>
  <td>If true, documents that already exist in OUTPUT_CONNECTION
    are not overwritten. This only affects operations when
    OUTPUT_CONNECTION is defined. If false,
    or if targeting an OUTPUT_PACKAGE<!-- or an OUTPUT_PATH -->,
    then all documents will be overwritten.
  </td>
</tr>

<tr>
  <td>THREADS</td><td>1</td>
  <td>Number of worker threads to spawn.</td>
</tr>

<tr><td>THROTTLE_BYTES_PER_SECOND</td><td>0</td>
<td>If non-zero, all threads will be throttled
  to the given number of bytes inserted per second.</td>
</tr>

<tr><td>THROTTLE_EVENTS_PER_SECOND</td><td>0</td>
<td>If non-zero, all threads will be throttled
  to the given number of inserts per second.</td>
</tr>

<tr><td>TMP_DIR</td><td>null</td>
<td>
Specify the temorary directory location.  This is used for creating
the temporary file for storing URIs.  See also the
INPUT_CONNECTION_STRING property.
</td>
</tr>

<tr><td>URI_QUEUE_FILE</td><td>null</td>
<td>
Specify the temorary file location.  This is used for creating the
temporary file for storing URIs.  See also the INPUT_CONNECTION_STRING
property.  If both URI_QUEUE_FILE and TMP_DIR are specified, xqsync
would only use URI_QUEUE_FILE.
</td>
</tr>

<tr>
  <td>URI_PREFIX</td><td>null</td>
  <td>String to prepend to all output uris.</td>
</tr>
<tr>
  <td>URI_PREFIX_STRIP</td><td>null</td>
  <td>String to strip from the beginning of all output uris,
    when present in those uris.</td>
</tr>
<tr>
  <td>URI_SUFFIX</td><td>null</td>
  <td>String to append to all output uris.</td>
</tr>
<tr>
  <td>URI_SUFFIX_STRIP</td><td>null</td>
  <td>String to strip from the end of all output uris,
    when present in those uris.</td>
</tr>

<tr>
  <td>ENCODE_OUTPUT_URI</td><td>false</td>
  <td>
    If true, xqsync will encode URIs so that they'll conform to the URI standard.
  </td>
</tr>

<tr>
  <td>USE_RANDOM_OUTPUT_URI</td><td>false</td>
  <td>
    If true, xqsync will generate random URIs for inserting documents into MarkLogic.  URI_PREFIX and URI_SUFFIX will still be obeyed.
  </td>
</tr>

<tr>
  <td>USE_IN_FOREST_EVAL</td><td>false</td>
  <td>
    Use in-forest eval when inserting documents into MarkLogic.
    XQSync would use OUTPUT_FORESTS as the list of eval forest if
    specified.  Otherwise, it'll use all of the forests in the output
    database.  By turning on this mode, XQSync will not delete URIs
    that have 0 content bytes.  Also, SKIP_EXISTING will not work.
  </td>
</tr>

<tr>
  <td>CHECKSUM_MODULE</td><td>null</td>
  <td>
    The checksum module to invoke when transferring documents between
    2 MarkLogic databases.  If this is specified, xqsync will use this
    module to compute a checksum from the source database and the
    destination database, and compare.  If the checksum does not
    match, xqsync will print out a warning.  A simple checksum module
    should look like this:
<pre>
declare variable $URI external;

(: must return 0 for empty or non-existence URIs :)

if ($URI and fn:doc-available($URI)) then
xdmp:md5(fn:concat(
  xdmp:quote(fn:doc($URI)),
  xdmp:quote(xdmp:document-properties($URI)),
  for $i in xdmp:quote(xdmp:document-get-collections($URI))
  order by $i
  return $i
))
else 0
</pre>
  </td>
</tr>

</table>

<a id="Customization"><h2>Customization</h2></a>

<p>
  Some users may which to customize XQSync more deeply than allowed
  by the existing configuration options. This can be done by supplying
  a property <code>CONFIGURATION_CLASSNAME</code>. This must be a subclass
  of com.marklogic.ps.xqsync.Configuration, and can extend or override
  its method implementations.
</p>

<p>
  For an example subclass,
  see <code>com.marklogic.ps.tests.ExampleConfiguration</code>.
  A typical implementation might override one or more of these methods:
  <ul>
    <li><code>close()</code></li>
    <li><code>configure()</code></li>
    <li><code>newReader()</code></li>
    <li><code>newWriter()</code></li>
  </ul>
</p>

<p>
  Note that this feature should be considered experimental.
  The implementation may change at any time,
  and may not be backward-compatible with existing customizations.
</p>

</body>
</html>
